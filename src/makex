#!/usr/bin/ksh -p

########################################################################
#
#	make an executable file from an iC file
#
########################################################################

usage ()
{
    echo 'Usage:	'${0##*/}' [-[l|s|c|b|n]6h] [-v<N>] file ...' >&2
    echo '    (default)	link all files into independent executables' >&2
    echo '	-l	link all files into one executable' >&2
    echo '	-s	supress C output and executable, listing only' >&2
    echo '	-c	generate C output only' >&2
    echo '	-b	generate both listing and C output' >&2
    echo '	-n	generate no output, report pplc compile errors only' >&2
    echo '		-s and -n generate cexe.c for last file as a side effect' >&2
    echo '	-v<N>	use pplc<N> eg pplc1 pplc2 ...' >&2
    echo '	-6	produce logic generation listing file.lst6' >&2
    echo '		default listing is file.lst' >&2
    echo '	-A	compile output ARITHMETIC ALIAS nodes' >&2
    echo '	-h	this help text' >&2
    echo '	$Id: makex,v 1.9 2001/02/20 18:03:47 jw Exp $' >&2
}

link=0
flag=noerror
a=""
v=""
d="-d74"
l=""

while [[ $# > 0 ]]; do
    case $1 in
    -)	shift; break;;
    -*)	option=${1#?}
	while [[ -n "$option" ]]; do
	    case "$option" in
	    l*)	link=1;;
	    s*)	link=2;;
	    c*)	link=3;;
	    b*) link=4;;
	    n*) link=5;;
	    v*)	option=${option#?};
		if [[ -n $option ]]; then
		    v=$option;
		else
		    shift; v=$1;
		fi
		break;;
	    6*)	d="-d76";l="6";;
	    A*)	d="$d -A";;
	    h*)	usage; exit 255;;
	    *) aflag="-$option"; break;;
	    esac
	    option=${option#?}
	done;;
    *)	break;;
    esac
    shift
done

for f in $*; do
    file=$f
    base=${file%.*}
    if [[ $file = $base ]]; then
	file="$base.p"
    fi
    if [[ ! -f $file ]]; then
	echo "iC file $file does not exist" >&2
	usage
	exit 1;
    fi
    echo $file

    case $link in
    0)
	rm -f $base.c $base
	if nice pplc$v $d -o $base.c -l $base.lst$l $file; then
	    if nice gcc -g -DYYDEBUG -o $base $base.c list.c load$v.a; then
		$base -d540 > $base.ini
	    fi
	else
	    echo "pplc$v compile errors in '$file' - no executable '$base' generated" >&2
	fi ;;
    1)
	rm -f $base.c
	if nice pplc$v $a $d -o $base.c -l $base.lst$l $file; then
	    list="$list $base.c"
	else
	    list="$list ERROR:$base.c"
	    flag=error
	fi
	if [[ -z $first ]]; then
	    first=$base
	    a="-a"
	fi ;;
    2)
	if ! nice pplc$v $d -c -l $base.lst$l $file; then
	    echo "pplc$v compile errors in '$file'" >&2
	fi ;;
    3)
	rm -f $base.c
	if ! nice pplc$v -o $base.c $file; then
	    echo "pplc$v compile errors in '$file'" >&2
	fi ;;
    4)
	rm -f $base.c
	if ! nice pplc$v $d -o $base.c -l $base.lst$l $file; then
	    echo "pplc$v compile errors in '$file'" >&2
	fi ;;
    5)
	if ! nice pplc$v -c $file; then
	    echo "pplc$v compile errors in '$file'" >&2
	fi ;;
    esac
done

if [[ $link = 1 ]]; then
    if [[ $flag = noerror ]]; then
	rm -f $first
	echo "link $first from$list"
	if nice gcc -g -DYYDEBUG -o $first $list list.c load$v.a; then
	    $first -d540 > $first.ini
	fi
    else
	echo "pplc$v compile errors in '$list'" >&2
    fi
fi
