#!/usr/bin/perl
########################################################################
#
#	iC generic Demo Box
#	adapted from
#	Example 14-1 Simple UI Code
#	Sriram Srinivasan: Advanced Perl p. 224
#
########################################################################

use Tk;					# Slurp the module in
use Msg;
#use strict;

########################################################################
#
#	Connect to server
#
########################################################################

my $host = (@ARGV == 2) ? $ARGV[1] : 'localhost';
my $port = 8080;

my $conn = Msg->connect($host, $port, \&rcvd_msg_from_server);
die "Client could not connect to $host:$port\n" unless $conn;
print "Connection successful.\n";
$conn->send_now($ARGV[0]) if $ARGV[0];

########################################################################
#
#	Create main window and Exit button
#
########################################################################

my $mainWindow = MainWindow->new();
$mainWindow->title("iC");
$mainWindow->Label(-text => "iC Demo Box")->pack;

$mainWindow->Button(-text    => "Exit",
		    -command => sub { exit },
		   )->pack(-side   => 'bottom', 
			   -expand => 1,
			   -fill   => 'x',
			  );

########################################################################
#
#	Generate an input and an output frame
#
########################################################################

my $inFrame  = $mainWindow->Frame(-label       => 'inputs',
				  -relief      => 'groove',
				  -borderwidth => 2,
				 )->pack(-side   => 'left', 
				         -expand => 'y',
				         -fill   => 'y',
				        );

my $outFrame = $mainWindow->Frame(-label       => 'outputs',
				  -relief      => 'groove',
				  -borderwidth => 2,
				 )->pack(-side   => 'right', 
				         -expand => 'y',
				         -fill   => 'y',
				        );

########################################################################
#
#	Generate 8 input checkbuttons and 8 output checkbuttons
#
########################################################################

my @inputs;

for (my $index = 0; $index < 8; $index++) {
    my $input = "I$ARGV[0].$index";
    $makeCheckbutton = "\
	\$inFrame->Checkbutton(\
	    -text        => \$input,\
	    -variable    => \\\$inputs[\$index],\
	    -selectcolor => 'green',\
	    -command     => sub {\
				 print \"Sending msg $index\\n\";\
				 \$conn->send_now(\"$index,\$inputs[$index]\");\
				},\
	)->pack(-side   => 'top',\
		-expand => 1,\
	);\
    ";
    eval $makeCheckbutton;
    print $@;
}

my @outputs;

for (my $index = 0; $index < 8; $index++) {
    my $output = "Q$ARGV[0].$index";
    $makeCheckbutton = "\
	\$outFrame->Checkbutton(\
	    -text        => \$output,\
	    -variable    => \\\$outputs[\$index],\
	    -selectcolor => 'red',\
#	    -state       => 'disabled',\
	    -takefocus   => 0,\
	    -command     => sub {\
				 print \"Inverting outputs $index\\n\";\
				 \$outputs[$index] = [1,0]->[\$outputs[$index]];\
				},\
	)->pack(-side   => 'top',\
		-expand => 1,\
	);\
    ";
    eval $makeCheckbutton;
    print $@;
    $outputs[$index] = 0;
}

########################################################################
#
#	Register read events
#
########################################################################

$mainWindow->fileevent($conn->{sock}, 'readable', sub { Msg->event_loop(1); });

########################################################################
#
#	Sit in an infinite loop dispatching incoming events.
#
########################################################################

MainLoop;

########################################################################
#
#	Receive message from server - adjust outputs
#
########################################################################

sub rcvd_msg_from_server {
    my ($conn, $msg, $err) = @_;
    if (defined $msg) {
        my $len = length ($msg);
#	print "($len)$msg\n";
	if ($len == 0) {
	    $conn->disconnect();
	    print "DemoBox $xID disconnected by server\n";
	    exit;
	}
	my ($index, $value) = split /,/, $msg;
#	print "$index $value $outputs[$index]\n";
	$outputs[$index] = $value;
    }
}
__END__

while (Tk::MainWindow->Count) {
    DoOneEvent(0);
    print "#";
}
print "\nQuit\n";
$mainWindow->fileevent($conn->{sock}, 'readable', undef);
$conn->disconnect();
Msg->event_loop();
