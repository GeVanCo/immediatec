#!/bin/bash

usage ()
{
    echo 'Usage:	'${0##*/}' [-ASRiIJ6xzh] [-y<opt>]' >&2
    echo '	-y<opt>	call immcc with extra -d<opt> orred into normal -d474' >&2
    echo '	-A	compile output ARITHMETIC ALIAS nodes for symbol debugging' >&2
    echo '	-S	strict compile - all immediate variables must be declared' >&2
    echo '	-R      no maximum error count (default: abort after 100 errors)' >&2
    echo '	-i	produce file.ini with load info but no INITIALIZATION' >&2
    echo '	-I	produce file.ini with load info and full INITIALIZATION' >&2
    echo '	-J	produce file.ini without load info but full INITIALIZATION' >&2
    echo '	-6	produce logic generation listing file.lst6' >&2
    echo '	-x	auxiliary files .iC_list1.h .iC_list2.h not deleted' >&2
    echo '	-z	echo compiler calls with all options for debugging' >&2
    echo '	-h	this help text' >&2
    echo 'uses immcc -d76 -y<opt> x.ic to make each line of the list pp.lt' >&2
    echo 'uses immcc -d74 -y<opt> -o x.c x.ic to make each line of the list pp.lt' >&2
    echo '	$Id: my,v 1.10 2005/09/04 19:40:41 jw Exp $' >&2
}

v=""
y=""
x=0
z=0
A=""
I=""
g=""

while [ $# -gt 0 ]; do
    case $1 in
    -)	shift; break;;
    -*)	option=${1#?}
	while [ -n "$option" ]; do
	    case "$option" in
	    y*)	option=${option#?}
		if [ -n "$option" ]; then
		    v="$v -d$option"
		    y="$y -y$option"
		else
		    echo "-y must specify an option";
		    usage; exit 254;
		fi
		break;;
	    A*)	A="$A -A";;
	    S*)	A="$A -S";;
	    R*)	A="$A -R";;
	    i*) I=" -i";;
	    I*) I=" -I";;
	    J*) I=" -J";;
	    6*) g="6";;
	    x*)	x=1;v="$v -d4000";;
	    z*)	z=1;;
	    h*)	usage; exit 255;;
	    *)	echo "unknown flag -$option";
		usage; exit 255;;
	    esac
	    option=${option#?}
	done;;
    *)	break;;
    esac
    shift
done
if [ -f pp.lt ]; then
    if [ -n "$g" ]; then
	for file in $(cat pp.lt); do
	    f=${file%.*}
	    if [ $z -eq 1 ]; then
		echo "immcc -d76$v$A -l $f.lst6 $f.ic" >&2
	    fi
	    echo $file
	    immcc -d76$v$A -l $f.lst6 $f.ic;
	done 2>&1 | sed '/^\/tmp\/[a-z_A-Z][a-z_A-Z0-9]*\.o\((\.[a-z][a-z]*+0x[0-9a-f]*)\)*:/ s//\/tmp\/x.o:/' > Init.out6
    fi
    for file in $(cat pp.lt); do
	f=${file%.*}
	if [ $z -eq 1 ]; then
	    echo "iCmake$I$y$A $f.ic" >&2
	fi
	iCmake$I$y$A $f.ic
    done 2>&1 | sed '/^\/tmp\/[a-z_A-Z][a-z_A-Z0-9]*\.o\((\.[a-z][a-z]*+0x[0-9a-f]*)\)*:/ s//\/tmp\/x.o:/' > Init.out
    # clean up temporary files generated by immcc compiler unless -x option
    if [ $x -ne 1 ]; then
	rm -f .iC_list1.h .iC_list2.h ic[0-9].*
    fi
else
    echo "no list of files 'pp.lt' found - use ml to generate it" >&2
    usage; exit 255;
fi
