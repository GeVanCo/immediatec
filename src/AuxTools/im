#!/bin/bash

usage ()
{
  echo 'Usage:' >&2
  echo "  $name[ -e xxx][ -ASxzh]" >&2
  echo "	-e xxx	execute with iC compiler xxx (default $ic)" >&2
  echo '	-A	compile output ARITHMETIC ALIAS nodes for symbol debugging' >&2
  echo '	-S	strict compile - all immediate variables must be declared' >&2
  echo '	-O <l>  optimisation -O0 none -O1 bit -O2 arithmetic -O3 both (default)' >&2
  echo '	-x	auxiliary files .iC_list1.h etc not deleted; no pplstfix' >&2
  echo '	-z	echo compiler calls with all options for debugging' >&2
  echo '	-h	this help text' >&2
  echo '	$Id: im,v 1.5 2007/06/10 13:40:13 archiv Exp $' >&2
}

name=${0##*/}
ic='./immcc'
A=""
O=""
x=0
z=0

while getopts ":e:ASO:xzh" opt; do
    case $opt in
    e )	ic="$OPTARG";;
    A )	A="$A -A";;
    S )	A="$A -S";;
    O )	A="$A -O$OPTARG";;
    x )	A="$A -d4000"; x="1";;
    z )	z=1;;
    h )	usage; exit 0;;
    \?)	echo "$name: illegal option '-$OPTARG'"; usage; exit 127;;
    esac
done
shift $(($OPTIND - 1))

for f in $*; do
    file=$f
    base=${file%.*}
    if [ "$file" = "$base" ]; then
	file="$base.ic"
    fi
    if [ -f "$file" ]; then
	if [ $z -eq 1 ]; then
	    echo "$ic$A -d474(6) -o $base.c -l $base.lst $file"
	else
	    echo $file
	fi
	$ic$A -d474 -o $base.c -l $base.lst $file
	$ic$A -d476 -o $base.c -l $base.lst6 $file
    else
	echo "Error: iC file '$file' does not exist" >&2
    fi
done

# clean up temporary files generated by immcc compiler unless -x option
if [ $x -ne 1 ]; then
    rm -f .iC_list1.h .iC_list2.h
fi
