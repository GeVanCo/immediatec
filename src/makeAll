#!/bin/bash

########################################################################
#
#	Copyright (C) 2000-2005  John E. Wulff
#
#   You may distribute under the terms of either the GNU General Public
#   License or the Artistic License, as specified in the README file.
#
#   For more information about this program, or for information on how
#   to contact the author, see the README file or <john@je-wulff.de>
#
#	make immcc ict libict.a lmain
#
#	make these individually with -C -T -L and -M flags
#	when any of these are set, cexe.c is not modified
#
#	use egrep rather than grep -E so it works on older Unix systems
#
########################################################################

usage ()
{
    echo 'Usage:	'${0##*/}' [-qgcrtlmdeCRTLMszh] [-D<OPT>] [-o<OBJ>]' >&2
    echo '	call make for immcc, ict, libict.a and lmain with the correct options' >&2
    echo '	-q	output only headings and error messages' >&2
    echo '	-g	compile for debugging and no optimisation (default -O2)' >&2
    echo '	-c	make immcc iC compiler with YYDEBUG' >&2
    echo '	-r	make icr iC compiler with YYDEBUG -t trace output possible' >&2
    echo '	-t	make ict iC compiler with YYDEBUG -t trace output possible' >&2
    echo '	-l	make libict.a with YYDEBUG -t trace output possible' >&2
    echo '	-m	make lmain test internal C compiler with YYDEBUG' >&2
    echo '	-u	make any compiler targets with Symbol SYUNION option' >&2
    echo '	-D<OPT>	make all targets with <OPT> defined' >&2
    echo '	see usage of immcc, icr, ict and applications for other options' >&2
    echo '	-C	make immcc only; generate an empty cexe.c' >&2
    echo '	-R	make icr only without modifying cexe.c' >&2
    echo '	-T	make ict only without modifying cexe.c' >&2
    echo '	-L	make libict.a only' >&2
    echo '	-M	make lmain only' >&2
    echo '	-W<OPT>	compile all C sources with -W<OPT> (useful for -Wall)' >&2
    echo '	-e	make all targets with EFENCE option and link with -lefence' >&2
    echo '	-d	make with -DDEQ Gate option (make clean required first)' >&2
    echo '		double ended queue processing is slightly faster' >&2
    echo '	-s	make with -DINT_MAX=32767 (make clean required first)' >&2
    echo '		(on a 16 bit system INT_MAX is 32767 and -s is not required)' >&2
    echo '		simulates compilation for a 16 bit system, which does' >&2
    echo '		no 32 bit arithmetic and rejects QL.. and IL.. I/O unless' >&2
    echo '	-z	make with -DLONG16        (make clean required first)' >&2
    echo '		produces code for long int arithmetic on a 16 bit system' >&2
    echo '	-o<OBJ>	define object extension (o is default; obj for Windows)' >&2
    echo '	-h	this help text' >&2
    echo '	$Id: makeAll,v 1.25 2007/02/17 14:54:56 jw Exp $' >&2
}

makeIcr ()
{
    mv comp.$O genr.$O gram.$O icr.$O misc.$O init.$O lexc.$O link.$O icc.$O outp.$O rsff.$O scan.$O symb.$O Make_tmp 2> /dev/null
    if [ -d IcrObjs ]; then
	mv IcrObjs/* .
    else
	mkdir IcrObjs
    fi
    make OPT="-DRUN$r$u$d$e$o$s$z" CFLAGS="$cflags" icr
    mv comp.$O genr.$O gram.$O icr.$O misc.$O init.$O lexc.$O link.$O icc.$O outp.$O rsff.$O scan.$O symb.$O IcrObjs
    mv Make_tmp/* . 2> /dev/null
}

makeIct ()
{
    mv comp.$O genr.$O gram.$O ict.$O misc.$O init.$O lexc.$O link.$O icc.$O outp.$O rsff.$O scan.$O symb.$O tcpc.$O Make_tmp 2> /dev/null
    if [ -d IctObjs ]; then
	mv IctObjs/* .
    else
	mkdir IctObjs
    fi
    make OPT="-DTCP$t$u$d$e$o$s$z" CFLAGS="$cflags" ict
    mv comp.$O genr.$O gram.$O ict.$O misc.$O init.$O lexc.$O link.$O icc.$O outp.$O rsff.$O scan.$O symb.$O tcpc.$O IctObjs
    mv Make_tmp/* . 2> /dev/null
}

makeLib ()
{
    mv ict.$O misc.$O link.$O rsff.$O scan.$O tcpc.$O  Make_tmp 2> /dev/null
    if [ -d LibObjs ]; then
	mv LibObjs/* .
    else
	mkdir LibObjs
    fi
    make OPT="-DLOAD -DTCP$l$d$e$o$s$z" CFLAGS="$cflags" libict.a
    mv ict.$O misc.$O link.$O rsff.$O scan.$O tcpc.$O  LibObjs
    mv Make_tmp/* . 2> /dev/null
}

makeLmain ()
{
    mv misc.$O gram.$O lexc.$O Make_tmp 2> /dev/null
    if [ -d LmainObjs ]; then
	mv LmainObjs/* .
    else
	mkdir LmainObjs
    fi
    make OPT="-DLMAIN$m$u$d$e$o$s$z" CFLAGS="$cflags" lmain
    mv misc.$O gram.$O lexc.$O LmainObjs
    mv Make_tmp/* . 2> /dev/null
}

q=""
c=""
r=""
t=""
l=""
m=""
u=""
d=""
e=""
s=""
z=""
C=0
R=0
T=0
L=0
M=0
ALL=1
cflags="-O2"			# optimisation, no debugging info
O="o"
o=""
w=""

while [ $# -gt 0 ]; do
    case $1 in
    -)	shift; break;;
    -*)	option=${1#?}
	while [ -n "$option" ]; do
	    case $option in
	    q*)	q=1;;		# echo only - dont kill
	    g*)	cflags="-g$w";;	# debugging, no optimisation
	    c*)	c="-DYYDEBUG";;
	    r*)	r=" -DYYDEBUG";;
	    t*)	t=" -DYYDEBUG";;
	    l*)	l=" -DYYDEBUG";;
	    m*)	m=" -DYYDEBUG";;
	    u*)	u=" -DSYUNION";;
	    d*)	d=" -DDEQ";;
	    e*)	e=" -DEFENCE";;
	    D*)	option=${option#?}
		if [ -z "$option" ]; then
		    shift
		    option=$1
		fi
		o=" -D$option"
		break;;
	    W*)	option=${option#?}
		if [ -z "$option" ]; then
		    shift
		    option=$1
		fi
		w=" -W$option"
		if [ -n "$cflags" ]; then
		    cflags="$cflags$w"
		fi
		break;;
	    s*)	s=" -DINT_MAX=32767";;
	    z*)	z=" -DLONG16";;
	    C*)	C=1; ALL=0;;
	    R*)	R=1; ALL=0;;
	    T*)	T=1; ALL=0;;
	    L*)	L=1; ALL=0;;
	    M*)	M=1; ALL=0;;
	    o*)	option=${option#?}
		if [ -z "$option" ]; then
		    shift
		    option=$1
		fi
		O="$option"
		break;;
	    h*)	usage; exit 255;;
	    *)	x=${option#?}; option=${option%$x}
	    	echo "$name: unexpected option $option in $1" >&2
		usage; exit 254;;
	    esac
	    option=${option#?}
	done
	;;
    *)	break;;
    esac
    shift
done

if [ -f Make_tmp ]; then
    echo 'Error makeAll: Make_tmp exists as file ??? - nothing made' >&2
    exit 1;
fi
test -d Make_tmp || mkdir Make_tmp;

rm -f icg.h
perl icg.pl $d$s$z icc.h > icg.h

if [ $ALL = 1 ] || [ $C = 1 ]; then
    echo "make OPT=\"$c$u$d$e$o$s$z\" CFLAGS=\"$cflags\" immcc"
    make OPT="$c$u$d$e$o$s$z" CFLAGS="$cflags" immcc 2>&1 | if [ -n "$q" ]; then egrep -i "(error|warning|unrecognized|up to date|:[A-Z_a-z. 0-9]+:)"; else cat; fi
fi

if [ $ALL = 1 ] || [ $R = 1 ]; then
    echo "make OPT=\"-DRUN$r$u$d$e$o$s$z\" CFLAGS=\"$cflags\" icr"
    makeIcr  2>&1 | if [ -n "$q" ]; then egrep -i "(error|warning|unrecognized|up to date|:[A-Z_a-z. 0-9]+:)"; else cat; fi
fi

if [ $ALL = 1 ] || [ $T = 1 ]; then
    echo "make OPT=\"-DTCP$t$u$d$e$o$s$z\" CFLAGS=\"$cflags\" ict"
    makeIct  2>&1 | if [ -n "$q" ]; then egrep -i "(error|warning|unrecognized|up to date|:[A-Z_a-z. 0-9]+:)"; else cat; fi
fi

if [ $ALL = 1 ] || [ $L = 1 ]; then
    echo "make OPT=\"-DLOAD -DTCP$l$d$e$o$s$z\" CFLAGS=\"$cflags\" libict.a"
    makeLib  2>&1 | if [ -n "$q" ]; then egrep -i "(error|warning|unrecognized|up to date|:[A-Z_a-z. 0-9]+:)"; else cat; fi
fi

if [ $ALL = 1 ] || [ $M = 1 ]; then
    echo "make OPT=\"-DLMAIN$m$u$d$e$o$s$z\" CFLAGS=\"$cflags\" lmain"
    makeLmain  2>&1 | if [ -n "$q" ]; then egrep -i "(error|warning|unrecognized|up to date|:[A-Z_a-z. 0-9]+:)"; else cat; fi
fi

rmdir Make_tmp
exit 0

############ POD to generate man page ##################################

=head1 NAME

 makeAll - supports Makefile in immcc develeopment

=head1 SYNOPSIS

    makeAll [-qgcrtlmdeCRTLMszh] [-D<OPT>] [-o<OBJ>]
    call make for immcc, ict, libict.a and lmain with the correct options
    -q      output only headings and error messages
    -g      compile for debugging and no optimisation (default -O2)
    -c      make immcc with YYDEBUG
    -r      make icr with YYDEBUG -t trace output possible
    -t      make ict with YYDEBUG -t trace output possible
    -l      make libict.a with YYDEBUG -t trace output possible
    -m      make lmain with YYDEBUG
    -D<OPT> make all targets with <OPT> defined
            see usage of immcc, icr, ict and applications for other options
    -C      make immcc only; generate an empty cexe.c
    -R      make icr only without modifying cexe.c
    -T      make ict only without modifying cexe.c
    -L      make libict.a only
    -M      make lmain only
    -W<OPT> compile all C sources with -W<OPT> (useful for -Wall)
    -e      make all targets with EFENCE option and link with -lefence
    -d      make with -DDEQ           (make clean required first)
            double ended queue processing is slightly faster
    -s      make with -DINT_MAX=32767 (make clean required first)
            (on a 16 bit system INT_MAX is 32767 and -s is not required)
            simulates compilation for a 16 bit system, which does
            no 32 bit arithmetic and rejects QL.. and IL.. I/O unless
    -z      make with -DLONG16        (make clean required first)
            produces code for long int arithmetic on a 16 bit system
    -o<OBJ> define object extension (o is default; obj for Windows)
    -h      this help text

=head1 DESCRIPTION

makeAll is a shell script to support the Makefile to build various
versions of the immcc compiler. Normally only the 'immcc' compiler and
'libict.a' are required for production systems.

'icr' is an early version of the compiler which builds its run-time
structures in memory and interprets these directly after compilation. I/O
is via the terminal and very limited. It was very useful in the early
part of development and will not be developed further.

'ict' is another version of the compiler which builds its run-time
structures in memory and interprets these directly after compilation. I/O
is via TCP/IP and iCserver.

'lmain' is a standalone check for the integrated C-compiler in gram.y and
lex.c.

  to make immcc, make with OPT=''
  to make icr, make with OPT='-DRUN -DYYDEBUG'
  to make ict, remove all objects and make with OPT='-DTCP'
  to make libict.a, remove all objects and make with OPT='-DLOAD -DTCP'
  to make lmain, remove all objects and make with OPT='-DLMAIN -DYYDEBUG'

    makeAll -rm; # called for all: does this automatically

another useful call is:

    makeAll -qgcrtlm;

which makes all quietly with debugging and YYDEBUG support

=head1 AUTHOR

John E. Wulff

=head1 BUGS

Email bug reports to B<john@je-wulff.de> with S<L<iC Project>> in
the subject field.

=head1 SEE ALSO

L<immcc(1)>, L<iCserver(1)>

=head1 COPYRIGHT

COPYRIGHT (C) 2000-2005  John E. Wulff

You may distribute under the terms of either the GNU General Public
License or the Artistic License, as specified in the README file.

For more information about this program, or for information on how
to contact the author, see the README file.
